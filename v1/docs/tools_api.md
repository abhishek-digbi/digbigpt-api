# Tools API

Endpoints for listing and executing registered tools and resolving variables through the same path used by prompts.

Base path: `/api`

## List Tools
- Method: GET
- Path: `/api/tools`
- Description: Lists tool names and descriptions from ToolService and the global registry.

Response
```
{
  "message": "Success",
  "status": 200,
  "timestamp": 1730000000000,
  "result": [
    { "name": "get_journey_events", "description": "..." },
    { "name": "get_cgm_tir_by_date", "description": "..." }
  ]
}
```

## Execute Tool
- Method: POST
- Path: `/api/tools/execute/{tool_name}`
- Description: Executes a registered tool by name with optional arguments.

Request
```
{
  "user_token": "<USER_TOKEN>",
  "use_cache": true,        // optional, if the tool supports it
  "args": {                 // optional tool-specific args
    "date": "2025-08-31"
  }
}
```

Notes
- `user_token` is bound automatically if the underlying tool accepts it.
- `use_cache` is injected only when the tool signature supports a `use_cache` parameter (variable tools generated by ToolService do).
- When the upstream returns no data (e.g., network/auth problems), the endpoint returns `502` with a hint payload to aid debugging.

Response (success)
```
{
  "message": "Success",
  "status": 200,
  "timestamp": 1730000000000,
  "result": { /* tool-specific result */ }
}
```

Response (upstream empty)
```
{
  "message": "Upstream tool returned no result",
  "status": 502,
  "timestamp": 1730000000000,
  "result": {
    "tool": "get_journey_events",
    "hint": "Check DIGBI_URL, DIGBI_USER_AUTH_TOKEN, and user_token validity.",
    "args_keys": ["date"],
    "has_user_token": true
  }
}
```

Examples
- Journey events
```
curl -sS -X POST http://localhost:9000/api/tools/execute/get_journey_events \
  -H 'Content-Type: application/json' \
  -d '{"user_token":"<USER_TOKEN>","use_cache":false}' | jq
```

- CGM TIR by date
```
curl -sS -X POST http://localhost:9000/api/tools/execute/get_cgm_tir_by_date \
  -H 'Content-Type: application/json' \
  -d '{"user_token":"<USER_TOKEN>","args":{"date":"2025-08-31"}}' | jq
```

## Resolve Variables
- Method: POST
- Path: `/api/tools/variables`
- Description: Resolves one or more variables via `ToolService.process_variables` â€” the same path used by LangFuse prompt hydration. Useful for debugging default processing and caching.

Request
```
{
  "user_token": "<USER_TOKEN>",
  "variables": ["journey_events", "nd_scores_last_n_days"],
  "use_cache": true,         // optional, defaults to true
  "last_num_days": 7         // optional hint; used when variables are time-ranged
}
```

Response
```
{
  "message": "Success",
  "status": 200,
  "timestamp": 1730000000000,
  "result": {
    "journey_events": [ /* raw list from upstream */ ],
    "nd_scores_last_n_days": { /* processed object */ }
  }
}
```

Why result is a map
- `process_variables` is designed to hydrate multiple variables at once and returns a mapping of `var_name -> value`. The endpoint mirrors this to test the exact prompt hydration flow.

## Environment and Auth
- These endpoints call Digbi APIs via the configured environment variables:
  - `DIGBI_URL` and `DIGBI_USER_AUTH_TOKEN` 
- Add authentication or rate limiting at the gateway/reverse proxy if needed.

